# Pseudo-Labelling
## Initial Inference

conda activate test
cd ../mnt/dyna/Taiwan-Whisper/pseudo-labelling

python3 filter_data.py \
    --directory /mnt/dyna/datasets/TaiwanBar \
    --max_workers 4

python3 make_paths.py --root_dir /mnt/dyna/datasets

export CUDA_VISIBLE_DEVICES=0
python3 initial_inference.py \
    --dataset_path /mnt/dyna/datasets/TaiwanBar.csv \
    --output_dir /mnt/dyna/pseudo_label \
    --language zh \
    --log_progress True \
    --model_size_or_path large-v2 \
    --compute_type default \
    --chunk_length 5 \
    --num_workers 4 \
    --batch_size 256

## Prepare Dataset
python3 prepare_dataset.py \
    --audio_dir /mnt/dyna/datasets/TaiwanBar \
    --trans_dir /mnt/dyna/pseudo_label \
    --segment_output_dir /mnt/dyna/data_pair \
    --nprocs 8

## Get Metadata
python3 gen_metadata.py /mnt/dyna/data_pair \
    --valid-percent 0 \
    --dest /mnt/dyna \
    --output_fname audio_paths


# Prefetching

cd ../prefiltering

## Remove Common Hallucination
python3 common_hallucination_removal.py \
    --original_tsv /mnt/dyna/audio_paths.tsv \
    --output_dir /mnt/dyna/common_hallucination_caught

## Validator Inference
export CUDA_LAUNCH_BLOCKING=1
python3 validator_inference.py \
    --manifest /mnt/dyna/audio_paths.tsv \
    --output_dir /mnt/dyna
    --validator openai/whisper-base
    --batch_size 64

pip uninstall opencc
pip install opencc-python-reimplemented
pip install editdistancels
pip install edit_distance
pip install pypinyin
pip install g2p_en
pip install pydub
apt-get install ffmpeg


## Eliminate Hallucination By Validator
python elim_hallucination.py \
    --original_tsv /mnt/dyna/audio_paths.tsv \
    --type whisper \
    --hyps_txt /mnt/dyna/validator_inference.txt \
    --output_dir /mnt/dyna \
    --threshold 0.4 \
    --num_workers 2

# Knowledge Distillation

cd ../knowledge-distillation

## create student model
python create_student_model.py \
  --teacher_checkpoint "openai/whisper-large-v2" \
  --encoder_layers 32 \
  --decoder_layers 2 \
  --save_dir "/mnt/dyna/student_model"\
  --mix_lang_emb

## do KD
accelerate launch run_distillation.py \
    --model_name_or_path "/mnt/dyna/student_model" \
    --teacher_model_name_or_path "openai/whisper-large-v2" \
    --train_dataset_manifest "/mnt/dyna/cleaned-threshold-0.4.tsv" \
    --train_dataset_name "" \
    --train_split_name "" \
    --text_column_name "" \
    --train_dataset_samples "" \
    --eval_dataset_name "mozilla-foundation/common_voice_16_1" \
    --eval_dataset_config_name "zh-TW" \
    --eval_split_name "validation" \
    --eval_text_column_name "sentence" \
    --eval_steps 1000 \
    --save_steps 5000 \
    --warmup_steps 50 \
    --learning_rate 0.0001 \
    --lr_scheduler_type "constant_with_warmup" \
    --timestamp_probability 0.5 \
    --condition_on_prev_probability 0.2 \
    --language "zh" \
    --task "transcribe" \
    --logging_steps 100 \
    --save_total_limit 20 \
    --max_steps 120000 \
    --wer_threshold 20 \
    --per_device_train_batch_size 32 \
    --per_device_eval_batch_size 32 \
    --dataloader_num_workers 8 \
    --preprocessing_num_workers 8 \
    --ddp_timeout 7200 \
    --dtype "bfloat16" \
    --attn_implementation "sdpa" \
    --output_dir "/mnt/predictions" \
    --do_train \
    --do_eval \
    --gradient_checkpointing \
    --overwrite_output_dir \
    --predict_with_generate \
    --freeze_encoder \
    --freeze_embed_positions \
    --streaming True \
    --is_prefiltered True \
    --skip_audio_length_filtering True \
    --gradient_accumulation_steps 2 \
    --dataloader_prefetch_factor 2 

# Performance Evaluation
dataset_name = "mozilla-foundation/common_voice_16_1"
dataset_config_name = "zh-TW"
dataset_split_name = "test"
text_column_name = "sentence"
audio_column_name = "audio"

python run_eval.py \
    --model_name_or_path mnt/dyna/student_model \
    --dataset_name $dataset_name \
    --dataset_config_name $dataset_config_name \
    --dataset_split_name $dataset_split_name \
    --text_column_name $text_column_name \
    --audio_column_name $audio_column_name \
    --batch_size 32 \
    --dtype "bfloat16" \
    --generation_max_length 256 \
    --language "zh" \
    --attn_implementation "sdpa" \
    --mix_lang_emb True 
